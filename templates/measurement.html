{% extends "base.html" %}
<!-- Indique que ce template utilise le fichier "base.html" comme base structurelle -->
<!-- Cela permet de rÃ©utiliser l'en-tÃªte HTML, le logo, les blocs communs et de ne dÃ©finir ici que le contenu spÃ©cifique Ã  la page de mesure -->

{% block title %}Mesure de Force et d'angle en Temps Reel{% endblock %}
<!-- Bloc permettant de dÃ©finir dynamiquement le titre affichÃ© dans l'onglet du navigateur -->
<!-- Ici, on Ã©crase le titre par dÃ©faut du template "base.html" pour l'adapter Ã  la page de mesure -->

{% block head %}
{# Debut du bloc head pour ajouter des fichiers CSS specifiques a cette page #}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/measurement.css') }}">
    <!-- Lien vers une feuille de style CSS spÃ©cifique Ã  cette page -->
    <!-- rel="stylesheet" : Indique qu'il s'agit d'un fichier CSS -->
    <!-- href : DÃ©finit le chemin vers ce fichier CSS -->
    <!-- les accolades: GÃ©nÃ¨re dynamiquement l'URL absolue en fonction du nom du fichier (ici : static/css/measurement.css) -->

{% endblock %}

{% block content %}
<!-- Bloc principal du corps de la page : tout ce qui s'affichera Ã  l'intÃ©rieur du <main> de base.html -->

<!-- Texte patient en haut -->
<div class="info">
<!-- Conteneur textuel affichant les informations liÃ©es au patient actuellement sÃ©lectionnÃ© -->
<!-- class="info" : Sert Ã  appliquer un style CSS pour l'apparence de cette zone -->

    Patient : <span class="highlight">{{ patient.patient_name }}</span> |
    <!-- Affiche le nom du patient en gras ou en surbrillance grÃ¢ce Ã  la classe "highlight" -->
    <!--  patient.patient_name  : Valeur dynamique injectÃ©e cÃ´tÃ© serveur par Jinja2 -->

    Doigt : <span class="highlight">{{ patient.finger }}</span> |
    <!-- Affiche le doigt mesurÃ© (index, majeur...) -->

    Phalange : <span class="highlight">{{ patient.phalange }}</span> |
     <!-- Affiche la section du doigt mesurÃ©e (ex. proximale, distale...) -->

    Operateur : <span class="highlight">{{ patient.operator }}</span>
    <!-- Affiche le nom de lâ€™opÃ©rateur ayant effectuÃ© la mesure -->
</div>

<!-- Bouton Sauvegarder -->
<div class="save-button-container">
    <!-- Conteneur pour centrer ou styliser le bouton "Sauvegarder les donnÃ©es" -->
    <button id="saveButton">Sauvegarder les donnees</button>
    <!-- <button> : Ã‰lÃ©ment HTML interactif permettant de dÃ©clencher une action (ici : enregistrer les donnÃ©es) -->
    <!-- id="saveButton" : Identifiant utilisÃ© par JavaScript pour attacher un Ã©vÃ©nement onclick -->

</div>


<!-- âœ… BOUTONS DE SIMULATION DE MESURES (TEST LOCAL SANS RASPBERRY) -->
<div class="save-button-container">
    <button onclick="simulateFakeMeasurementSeries('30Â°')">ðŸŽ¯ Simuler une sÃ©rie pour 30Â°</button>
    <button onclick="simulateFakeMeasurementSeries('45Â°')">ðŸŽ¯ Simuler une sÃ©rie pour 45Â°</button>
</div>


<!-- Conteneur global horizontal -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; width: 95%; margin: auto; gap: 30px;">
    <!-- Ce <div> structure deux colonnes horizontales (graphique Ã  gauche, panneau de contrÃ´le Ã  droite) -->
    <!-- display: flex â†’ active la disposition en ligne des Ã©lÃ©ments enfants -->
    <!-- justify-content: space-between â†’ espace maximal entre les deux colonnes -->
    <!-- align-items: flex-start â†’ aligne les blocs en haut du conteneur -->
    <!-- width: 95% â†’ largeur relative pour laisser un peu de marge Ã  gauche et droite -->
    <!-- margin: auto â†’ centre horizontalement le conteneur dans la page -->
    <!-- gap: 30px â†’ espace horizontal entre les deux colonnes -->

    <!-- Conteneur principal avec graphique et titre -->
    <div id="phalange-force-container" style="flex: 3;">
        <!-- flex: 3 â†’ ce bloc occupe 3 fois plus dâ€™espace que lâ€™autre colonne (rapport 3:1) -->

        <!-- Titre centrÃ© du graphique -->
        <h2 style="text-align: center;">
            <!-- Balise HTML <h2> pour afficher un sous-titre visible et structurÃ© -->
            <!-- text-align: center â†’ centre horizontalement le texte -->

            Force en fonction de l'angle mesurÃ© :
            <!-- Texte statique prÃ©cÃ©dant le dÃ©tail dynamique de la phalange -->

            {% if patient.phalange == "proximale" %}
                <!-- Si la phalange bloquÃ©e est "proximale", on dÃ©duit que les deux libres sont "distale" et "intermÃ©diaire" -->

                <span style="color: #d9534f; font-weight: bold;">Distale - IntermÃ©diaire</span>
                <!-- Affiche les deux phalanges libres en rouge (#d9534f) et en gras -->
            {% elif patient.phalange == "distale" %}
                <!-- Si la phalange bloquÃ©e est "distale", les libres sont "intermÃ©diaire" et "proximale" -->

                <span style="color: #007bff; font-weight: bold;">IntermÃ©diaire - Proximale</span>
                <!-- Affiche les phalanges libres en bleu (#007bff) et en gras -->
            {% else %}
                <!-- Cas par dÃ©faut : aucune phalange bloquÃ©e spÃ©cifiÃ©e -->

                (libre)
                <!-- Texte neutre, sans couleur ni emphase -->
            {% endif %}
        </h2>

        <!-- Graphique de force en fonction de lâ€™angle -->
        <div id="graph-force-vs-angle"></div>
        <!-- Ce <div> est utilisÃ© comme conteneur de graphique dynamique via Plotly.js -->
        <!-- Le code JavaScript insÃ¨re ici une figure avec les courbes enregistrÃ©es -->
    </div>

    <!-- Colonne droite Ã  lâ€™extÃ©rieur de la carte blanche -->
    <div id="series-controls-panel">
        <!-- Ce panneau contient les informations et les contrÃ´les liÃ©s aux sÃ©ries -->
        <!-- StylÃ© via le CSS (voir #series-controls-panel dans measurement.css) -->

        <p>
            <!-- Bloc de texte contenant lâ€™angle dÃ©tectÃ© -->
            <strong>Angle de blocage dÃ©tectÃ© :</strong>
            <!-- Titre en gras pour signaler que lâ€™information est importante -->

            <span id="autoAngleDisplay" style="font-weight: bold;">â€“</span>
            <!-- Zone qui sera remplie dynamiquement via JavaScript -->
            <!-- style="color: #28a745;" â†’ vert vif pour signaler une valeur active et valide -->
            <!-- Valeur par dÃ©faut affichÃ©e : tiret (â€“) tant quâ€™aucune mesure nâ€™a Ã©tÃ© lancÃ©e -->
        </p>

        <!-- Bouton pour dÃ©marrer une nouvelle sÃ©rie de mesure -->
        <button id="startSeriesButton" class="start-button">
            <!-- id="startSeriesButton" â†’ permet Ã  JS dâ€™ajouter un Ã©vÃ©nement "onclick" pour lancer une mesure -->
            <!-- class="start-button" â†’ permet de styliser le bouton (voir CSS associÃ©) -->
            DÃ©marrer une nouvelle mesure
            <!-- Emoji symbolisant un nouveau dÃ©part, et texte explicite pour lâ€™utilisateur -->
        </button>

        <!-- LibellÃ© associÃ© au menu dÃ©roulant ci-dessous -->
        <label for="seriesSelector" style="margin-top: 20px; display: block;">
            <!-- "for='seriesSelector'" â†’ connecte ce label au menu dÃ©roulant -->
            <!-- style="display: block;" â†’ force le retour Ã  la ligne pour que le label soit au-dessus du <select> -->
            <!-- margin-top: 20px â†’ ajoute de lâ€™espace au-dessus du label pour aÃ©rer lâ€™interface -->
            Afficher une sÃ©rie spÃ©cifique :
        </label>

        <!-- Menu dÃ©roulant permettant de filtrer les courbes visibles -->
        <select id="seriesSelector">
            <!-- Ce <select> est rempli dynamiquement depuis JavaScript en fonction des sÃ©ries enregistrÃ©es -->
            <!-- id="seriesSelector" â†’ permet de sÃ©lectionner et de gÃ©rer les courbes Ã  afficher -->

            <option value="all">Toutes les courbes</option>
            <!-- Option par dÃ©faut : affiche toutes les sÃ©ries superposÃ©es sur le graphique -->
            <!-- Les autres options sont ajoutÃ©es en JS Ã  la fin de chaque sÃ©rie automatiquement dÃ©tectÃ©e -->
        </select>
    </div>
</div>


<!-- Bloc principal qui contient les deux graphes et le bouton de contrÃ´le -->
<div id="measurement-page">
    <!-- Conteneur principal de tous les graphes de la page de mesure -->
    
    <div id="graphs-container">
        <!-- Conteneur horizontal : divise en deux panneaux les deux types de graphique -->

        <div id="left-panel">
            <!-- Panneau de gauche : contient le graphe de la force en fonction du temps -->
            <h2>Force en fonction du temps</h2>
            <div id="graph-force"></div>
        </div>

        <div id="separator"></div>
        <!-- Barre verticale de sÃ©paration visuelle entre les deux panneaux -->

        <div id="right-panel">
            <!-- Panneau de droite : contient le graphe de lâ€™amplitude articulaire -->
            <h2>Amplitude en fonction du temps</h2>

            <div id="angle-values" style="text-align: center; margin-bottom: 10px;">
                <!-- Conteneur centrÃ© affichant les deux valeurs d'angle (distal et proximal) -->
                <!-- style="text-align: center;" : centre le texte horizontalement -->
                <!-- margin-bottom: 10px; : ajoute un espacement vers le bas pour sÃ©parer visuellement ce bloc du graphique -->

                <strong style="color: #d9534f; font-weight: bold;">
                    <!-- Affiche le texte statique "Angle distal :" en rouge (#d9534f) et en gras -->
                    Angle distal :
                </strong>

                <span id="angle-distal" style="font-weight: bold;">â€“</span> Â°
                <!-- Affiche dynamiquement la valeur de lâ€™angle distal -->
                <!-- style="font-weight: bold;" : rend la valeur chiffrÃ©e plus visible pour l'utilisateur -->
                <!-- Le contenu de ce span est remplacÃ© dynamiquement en JavaScript via document.getElementById('angle-distal').textContent -->

                &nbsp;&nbsp;&nbsp;
                <!-- Ajoute un espacement horizontal visuel entre les deux textes (distal / proximal) -->

                <strong style="color: #007bff; font-weight: bold;">
                    <!-- Affiche le texte statique "Angle proximal :" en bleu (#007bff) et en gras -->
                    Angle proximal :
                </strong>

                <span id="angle-proximal" style="font-weight: bold;">â€“</span> Â°
                <!-- Affiche dynamiquement la valeur de lâ€™angle proximal -->
                <!-- Le style en gras permet de mieux lire la valeur en temps rÃ©el -->
                <!-- Ce span est aussi mis Ã  jour via JavaScript cÃ´tÃ© client -->
            </div>


            <div id="graph-amplitude"></div>
            <!-- Graphique dâ€™amplitude dynamique -->
        </div>
    </div>

    <div style="text-align: center; margin-top: 10px;">
        <!-- Zone contenant le bouton pour cacher/afficher les graphes -->
        <button id="toggleGraphsButton" class="graph-toggle-button">
            Cacher les graphiques
        </button>
        <!-- Ce bouton agira sur tout le bloc #measurement-page via JS -->
    </div>
</div>

<!-- âœ… Nouveau conteneur en dehors du bloc #measurement-page -->
<div class="new-measure-container">
    <!-- Cette zone reste toujours visible mÃªme si les graphiques sont masquÃ©s -->
    <button id="newMeasureButton">Nouvelle mesure</button>
    <!-- Bouton indÃ©pendant qui redirige l'utilisateur vers la page d'accueil -->
</div>


{% endblock %}
<!-- Fin du bloc principal de contenu propre Ã  la page de mesure -->

{% block scripts %}
<!-- Bloc dâ€™inclusion des scripts spÃ©cifiques Ã  cette page (JS externes, bibliothÃ¨ques CDN, etc.) -->
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <!-- Charge la bibliothÃ¨que Socket.IO (version CDN) -->
    <!-- UtilisÃ©e pour Ã©tablir une connexion en temps rÃ©el (WebSocket) entre le navigateur et le serveur Python/Flask -->


    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Charge la bibliothÃ¨que Plotly.js permettant de dessiner des graphiques interactifs (ex : force, amplitude) -->

    <script>
        window.DEBUG = true;  // Activer ou dÃ©sactiver tous les logs
        window.blockedPhalange = "{{ patient.phalange|lower }}";
        <!-- Injecte la phalange actuelle dans une variable JavaScript globale accessible dans measurement.js -->
        if (window.DEBUG) {
            console.log("ðŸ“¦ Phalange bloquÃ©e (depuis Jinja):", window.blockedPhalange);
            // <!-- Affiche la valeur dans la console pour vÃ©rification/debug -->
        }
    </script>

    <script src="{{ url_for('static', filename='js/measurement.js') }}"></script>
    <!-- Fichier JavaScript principal de la page, gÃ¨re l'affichage, les Ã©vÃ©nements et les interactions dynamiques -->
    <!-- url_for(...) : Permet de pointer dynamiquement vers ce fichier dans le dossier static/js -->


{% endblock %}
<!-- Fin du bloc des scripts propres Ã  cette page -->


{% extends "base.html" %}
<!-- Indique que ce template utilise le fichier "base.html" comme base structurelle -->
<!-- Cela permet de r√©utiliser l'en-t√™te HTML, le logo, les blocs communs et de ne d√©finir ici que le contenu sp√©cifique √† la page de mesure -->

{% block title %}Mesure de Force et d'angle en Temps Reel{% endblock %}
<!-- Bloc permettant de d√©finir dynamiquement le titre affich√© dans l'onglet du navigateur -->
<!-- Ici, on √©crase le titre par d√©faut du template "base.html" pour l'adapter √† la page de mesure -->

{% block head %}
{# Debut du bloc head pour ajouter des fichiers CSS specifiques a cette page #}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/measurement.css') }}">
    <!-- Lien vers une feuille de style CSS sp√©cifique √† cette page -->
    <!-- rel="stylesheet" : Indique qu'il s'agit d'un fichier CSS -->
    <!-- href : D√©finit le chemin vers ce fichier CSS -->
    <!-- les accolades: G√©n√®re dynamiquement l'URL absolue en fonction du nom du fichier (ici : static/css/measurement.css) -->

{% endblock %}

{% block content %}
<!-- Bloc principal du corps de la page : tout ce qui s'affichera √† l'int√©rieur du <main> de base.html -->

<!-- Texte patient en haut -->
<div class="info">
<!-- Conteneur textuel affichant les informations li√©es au patient actuellement s√©lectionn√© -->
<!-- class="info" : Sert √† appliquer un style CSS pour l'apparence de cette zone -->

    Patient : <span class="highlight">{{ patient.patient_name }}</span> |
    <!-- Affiche le nom du patient en gras ou en surbrillance gr√¢ce √† la classe "highlight" -->
    <!--  patient.patient_name  : Valeur dynamique inject√©e c√¥t√© serveur par Jinja2 -->

    Doigt : <span class="highlight">{{ patient.finger }}</span> |
    <!-- Affiche le doigt mesur√© (index, majeur...) -->

    Phalange : <span class="highlight">{{ patient.phalange }}</span> |
     <!-- Affiche la section du doigt mesur√©e (ex. proximale, distale...) -->

    Operateur : <span class="highlight">{{ patient.operator }}</span>
    <!-- Affiche le nom de l‚Äôop√©rateur ayant effectu√© la mesure -->
</div>

<!-- Bouton Sauvegarder -->
<div class="save-button-container">
    <!-- Conteneur pour centrer ou styliser le bouton "Sauvegarder les donn√©es" -->
    <button id="saveButton">Sauvegarder les donnees</button>
    <!-- <button> : √âl√©ment HTML interactif permettant de d√©clencher une action (ici : enregistrer les donn√©es) -->
    <!-- id="saveButton" : Identifiant utilis√© par JavaScript pour attacher un √©v√©nement onclick -->

</div>


<!-- Conteneur global horizontal -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; width: 95%; margin: auto; gap: 30px;">
    <!-- Ce <div> structure deux colonnes horizontales (graphique √† gauche, panneau de contr√¥le √† droite) -->
    <!-- display: flex ‚Üí active la disposition en ligne des √©l√©ments enfants -->
    <!-- justify-content: space-between ‚Üí espace maximal entre les deux colonnes -->
    <!-- align-items: flex-start ‚Üí aligne les blocs en haut du conteneur -->
    <!-- width: 95% ‚Üí largeur relative pour laisser un peu de marge √† gauche et droite -->
    <!-- margin: auto ‚Üí centre horizontalement le conteneur dans la page -->
    <!-- gap: 30px ‚Üí espace horizontal entre les deux colonnes -->

    <!-- Conteneur principal avec graphique et titre -->
    <div id="phalange-force-container" style="flex: 3;">
        <!-- flex: 3 ‚Üí ce bloc occupe 3 fois plus d‚Äôespace que l‚Äôautre colonne (rapport 3:1) -->

        <!-- Titre centr√© du graphique -->
        <h2 style="text-align: center;">
            <!-- Balise HTML <h2> pour afficher un sous-titre visible et structur√© -->
            <!-- text-align: center ‚Üí centre horizontalement le texte -->

            Force en fonction de l'angle mesur√© :
            <!-- Texte statique pr√©c√©dant le d√©tail dynamique de la phalange -->

            {% if patient.phalange == "proximale" %}
                <!-- Si la phalange bloqu√©e est "proximale", on d√©duit que les deux libres sont "distale" et "interm√©diaire" -->

                <span style="color: #d9534f; font-weight: bold;">Distale - Interm√©diaire</span>
                <!-- Affiche les deux phalanges libres en rouge (#d9534f) et en gras -->
            {% elif patient.phalange == "distale" %}
                <!-- Si la phalange bloqu√©e est "distale", les libres sont "interm√©diaire" et "proximale" -->

                <span style="color: #007bff; font-weight: bold;">Interm√©diaire - Proximale</span>
                <!-- Affiche les phalanges libres en bleu (#007bff) et en gras -->
            {% else %}
                <!-- Cas par d√©faut : aucune phalange bloqu√©e sp√©cifi√©e -->

                (libre)
                <!-- Texte neutre, sans couleur ni emphase -->
            {% endif %}
        </h2>

        <!-- Graphique de force en fonction de l‚Äôangle -->
        <div id="graph-force-vs-angle"></div>
        <!-- Ce <div> est utilis√© comme conteneur de graphique dynamique via Plotly.js -->
        <!-- Le code JavaScript ins√®re ici une figure avec les courbes enregistr√©es -->
    </div>

    <!-- Colonne droite √† l‚Äôext√©rieur de la carte blanche -->
    <div id="series-controls-panel">
        <!-- Ce panneau contient les informations et les contr√¥les li√©s aux s√©ries -->
        <!-- Styl√© via le CSS (voir #series-controls-panel dans measurement.css) -->

        <p>
            <!-- Bloc de texte contenant l‚Äôangle d√©tect√© -->
            <strong>Angle de blocage d√©tect√© :</strong>
            <!-- Titre en gras pour signaler que l‚Äôinformation est importante -->

            <span id="autoAngleDisplay" style="font-weight: bold;">‚Äì</span>
            <!-- Zone qui sera remplie dynamiquement via JavaScript -->
            <!-- style="color: #28a745;" ‚Üí vert vif pour signaler une valeur active et valide -->
            <!-- Valeur par d√©faut affich√©e : tiret (‚Äì) tant qu‚Äôaucune mesure n‚Äôa √©t√© lanc√©e -->
        </p>

        <!-- Bouton pour d√©marrer une nouvelle s√©rie de mesure -->
        <button id="startSeriesButton" class="start-button">
            <!-- id="startSeriesButton" ‚Üí permet √† JS d‚Äôajouter un √©v√©nement "onclick" pour lancer une mesure -->
            <!-- class="start-button" ‚Üí permet de styliser le bouton (voir CSS associ√©) -->
            D√©marrer une nouvelle mesure
            <!-- Emoji symbolisant un nouveau d√©part, et texte explicite pour l‚Äôutilisateur -->
        </button>

        <!-- üîµ Bouton pour interrompre manuellement la s√©rie en cours -->
         <button id="stopSeriesButton" class="start-button danger" style="margin-top: 10px;" disabled>
            üõë Interrompre la mesure
        </button>


        <!-- Libell√© associ√© au menu d√©roulant ci-dessous -->
        <label for="seriesSelector" style="margin-top: 20px; display: block;">
            <!-- "for='seriesSelector'" ‚Üí connecte ce label au menu d√©roulant -->
            <!-- style="display: block;" ‚Üí force le retour √† la ligne pour que le label soit au-dessus du <select> -->
            <!-- margin-top: 20px ‚Üí ajoute de l‚Äôespace au-dessus du label pour a√©rer l‚Äôinterface -->
            Afficher une s√©rie sp√©cifique :
        </label>

        <!-- Menu d√©roulant permettant de filtrer les courbes visibles -->
        <select id="seriesSelector">
            <!-- Ce <select> est rempli dynamiquement depuis JavaScript en fonction des s√©ries enregistr√©es -->
            <!-- id="seriesSelector" ‚Üí permet de s√©lectionner et de g√©rer les courbes √† afficher -->

            <option value="all">Toutes les courbes</option>
            <!-- Option par d√©faut : affiche toutes les s√©ries superpos√©es sur le graphique -->
            <!-- Les autres options sont ajout√©es en JS √† la fin de chaque s√©rie automatiquement d√©tect√©e -->
        </select>
    </div>
</div>


<!-- Bloc principal qui contient les deux graphes et le bouton de contr√¥le -->
<div id="measurement-page">
    <!-- Conteneur principal de tous les graphes de la page de mesure -->
    
    <div id="graphs-container">
        <!-- Conteneur horizontal : divise en deux panneaux les deux types de graphique -->

        <div id="left-panel">
            <!-- Panneau de gauche : contient le graphe de la force en fonction du temps -->
            <h2>Force en fonction du temps</h2>
            <div id="graph-force"></div>
        </div>

        <div id="separator"></div>
        <!-- Barre verticale de s√©paration visuelle entre les deux panneaux -->

        <div id="right-panel">
            <!-- Panneau de droite : contient le graphe de l‚Äôamplitude articulaire -->
            <h2>Amplitude en fonction du temps</h2>

            <div id="angle-values" style="text-align: center; margin-bottom: 10px;">
                <!-- Conteneur centr√© affichant les deux valeurs d'angle (distal et proximal) -->
                <!-- style="text-align: center;" : centre le texte horizontalement -->
                <!-- margin-bottom: 10px; : ajoute un espacement vers le bas pour s√©parer visuellement ce bloc du graphique -->

                <strong style="color: #d9534f; font-weight: bold;">
                    <!-- Affiche le texte statique "Angle distal :" en rouge (#d9534f) et en gras -->
                    Angle distal :
                </strong>

                <span id="angle-distal" style="font-weight: bold;">‚Äì</span> ¬∞
                <!-- Affiche dynamiquement la valeur de l‚Äôangle distal -->
                <!-- style="font-weight: bold;" : rend la valeur chiffr√©e plus visible pour l'utilisateur -->
                <!-- Le contenu de ce span est remplac√© dynamiquement en JavaScript via document.getElementById('angle-distal').textContent -->

                &nbsp;&nbsp;&nbsp;
                <!-- Ajoute un espacement horizontal visuel entre les deux textes (distal / proximal) -->

                <strong style="color: #007bff; font-weight: bold;">
                    <!-- Affiche le texte statique "Angle proximal :" en bleu (#007bff) et en gras -->
                    Angle proximal :
                </strong>

                <span id="angle-proximal" style="font-weight: bold;">‚Äì</span> ¬∞
                <!-- Affiche dynamiquement la valeur de l‚Äôangle proximal -->
                <!-- Le style en gras permet de mieux lire la valeur en temps r√©el -->
                <!-- Ce span est aussi mis √† jour via JavaScript c√¥t√© client -->
            </div>


            <div id="graph-amplitude"></div>
            <!-- Graphique d‚Äôamplitude dynamique -->
        </div>
    </div>

    <div style="text-align: center; margin-top: 10px;">
        <!-- Zone contenant le bouton pour cacher/afficher les graphes -->
        <button id="toggleGraphsButton" class="graph-toggle-button">
            Cacher les graphiques
        </button>
        <!-- Ce bouton agira sur tout le bloc #measurement-page via JS -->
    </div>
</div>

<!-- ‚úÖ Nouveau conteneur en dehors du bloc #measurement-page -->
<div class="new-measure-container">
    <!-- Cette zone reste toujours visible m√™me si les graphiques sont masqu√©s -->
    <button id="newMeasureButton">Nouvelle mesure</button>
    <!-- Bouton ind√©pendant qui redirige l'utilisateur vers la page d'accueil -->
</div>


{% endblock %}
<!-- Fin du bloc principal de contenu propre √† la page de mesure -->

{% block scripts %}
<!-- Bloc d‚Äôinclusion des scripts sp√©cifiques √† cette page (JS externes, biblioth√®ques CDN, etc.) -->
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <!-- Charge la biblioth√®que Socket.IO (version CDN) -->
    <!-- Utilis√©e pour √©tablir une connexion en temps r√©el (WebSocket) entre le navigateur et le serveur Python/Flask -->


    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Charge la biblioth√®que Plotly.js permettant de dessiner des graphiques interactifs (ex : force, amplitude) -->

    <script>
        window.DEBUG = true;  // Activer ou d√©sactiver tous les logs
        window.blockedPhalange = "{{ patient.phalange|lower }}";
        <!-- Injecte la phalange actuelle dans une variable JavaScript globale accessible dans measurement.js -->
        if (window.DEBUG) {
            console.log("üì¶ Phalange bloqu√©e (depuis Jinja):", window.blockedPhalange);
            // <!-- Affiche la valeur dans la console pour v√©rification/debug -->
        }
    </script>


    <script>
        // Rend les donn√©es du patient accessibles √† JavaScript via une variable globale
        window.patientData = {
            patient_name: "{{ patient.patient_name }}",  // Nom du patient
            finger: "{{ patient.finger }}",              // Doigt concern√©
            phalange: "{{ patient.phalange }}",          // Phalange bloqu√©e
            operator: "{{ patient.operator }}"           // Nom de l‚Äôop√©rateur
        };

        if (window.DEBUG) {
            console.log("üßæ Donn√©es patient inject√©es :", window.patientData);
        }
    </script>

    <script src="{{ url_for('static', filename='js/measurement.js') }}"></script>
    <!-- Fichier JavaScript principal de la page, g√®re l'affichage, les √©v√©nements et les interactions dynamiques -->
    <!-- url_for(...) : Permet de pointer dynamiquement vers ce fichier dans le dossier static/js -->


{% endblock %}
<!-- Fin du bloc des scripts propres √† cette page -->

